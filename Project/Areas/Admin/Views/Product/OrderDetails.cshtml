@using Core.Services.Interfaces;
@using Core.ViewModel;
@using Datalayer.Entities;
@using System.Globalization;

@model Order

@inject IProductService _productService;

@{
    ViewBag.Title = "جزییات سفارش " + Model.Id;

    string status = "";
    string style = "";


    switch (Model.IsFinal)
    {
        case true:
            {
                if (Model.Status == "NoShipping")
                {
                    status = "در حال انجام";
                    style = "background:#BD00C3;";
                }
                else if (Model.Status == "Completed")
                {
                    status = "کامل شده";
                    style = "background:#00C37A;";
                }
                else if (Model.Status == "NoPayment")
                {
                    status = "در انتظار پرداخت";
                    style = "background:gray;";
                }
                else if (Model.Status == "Canceled")
                {
                    status = "لغو شده";
                    style = "background:#C30000;";
                }
                else if (Model.Status == "Refund")
                {
                    status = "مرجوعی";
                    style = "background:#FF7A51;";
                }

                break;
            }
        case false:
            {
                status = "در حال سفارش";
                style = "background:#FFC500;";
                break;
            }
    }
}

<div class="wrapper wrapper-content animated fadeInRight">


    <div class="row">
        <div class="col-sm-9 no-padding">
            <div class="col-sm-12">
                @Html.ValidationSummary(true, "لطفا خطاهای زیر را برطرف نمایید:", new { @class = "text-danger alert alert-danger" })
            </div>
            <div class="col-sm-12">
                @{
                    if (ViewBag.Message != null)
                    {
                        <div class="col-sm-12 alert alert-success">
                            <span>@ViewBag.Message</span>
                        </div>
                    }
                }
            </div>
            <div class="col-sm-12">
                <div class="ibox float-e-margins">
                    <div class="ibox-title">
                        <h5>شماره سفارش @Model.Id</h5>
                        <div class="ibox-tools">
                            <a class="collapse-link">
                                <i class="fa fa-chevron-up"></i>
                            </a>
                            <a class="close-link">
                                <i class="fa fa-times"></i>
                            </a>
                        </div>
                    </div>

                    <div class="ibox-content">
                        <div class="elementDetails" style="width:100%;">
                            <label style="text-align:right" class="col-sm-2 control-label">وضعیت سفارش</label>
                            <span style="text-align:right" class="col-sm-10 control-label">
                                <span class="ActionTable" style="@style">@status</span>
                            </span>
                        </div>
                        <div class="elementDetails">
                            <label style="text-align:right" class="col-sm-4 control-label">نام</label>
                            <span style="text-align:right" class="col-sm-8 control-label">@Model.Name</span>
                        </div>
                        <div class="elementDetails">
                            <label style="text-align:right" class="col-sm-4 control-label">کد ملی</label>
                            <span style="text-align:right" class="col-sm-8 control-label">@Model.MelliCode</span>
                        </div>
                        <div class="elementDetails">
                            <label style="text-align:right" class="col-sm-4 control-label">موبایل</label>
                            <span style="text-align:right" class="col-sm-8 control-label">@Model.PhoneNumber</span>
                        </div>
                        <div class="elementDetails">
                            <label style="text-align:right" class="col-sm-4 control-label">تلفن ثابت</label>
                            <span style="text-align:right" class="col-sm-8 control-label">@Model.HomePhone</span>
                        </div>
                        <div class="elementDetails">
                            <label style="text-align:right" class="col-sm-4 control-label">استان</label>
                            <span style="text-align:right" class="col-sm-8 control-label">@_productService.GetCityById(_productService.GetStateOfCity(Model.CityId)).Name</span>
                        </div>
                        <div class="elementDetails">
                            <label style="text-align:right" class="col-sm-4 control-label">شهر</label>
                            <span style="text-align:right" class="col-sm-8 control-label">@_productService.GetCityById(Model.CityId).Name</span>
                        </div>
                        <div class="elementDetails" style="width:100%;">
                            <label style="text-align:right" class="col-sm-2 control-label">آدرس</label>
                            <span style="text-align:right" class="col-sm-10 control-label">
                                @Model.Address
                            </span>
                        </div>
                        <div class="elementDetails" style="width:100%;">
                            <label style="text-align:right" class="col-sm-2 control-label">توضیحات سفارش</label>
                            <span style="text-align:right" class="col-sm-10 control-label">
                                @Model.Description
                            </span>
                        </div>
                        <div class="clear"></div>
                    </div>
                </div>
            </div>


            <div class="col-sm-12">
                <div class="ibox float-e-margins">
                    <div class="ibox-title">
                        <h5>لیست محصولات</h5>
                        <div class="ibox-tools">
                            <a class="collapse-link">
                                <i class="fa fa-chevron-up"></i>
                            </a>
                            <a class="close-link">
                                <i class="fa fa-times"></i>
                            </a>
                        </div>
                    </div>

                    <div class="ibox-content">
                        <div id="orderProductTable">
                            <partial name="_orderProductTable" model="Model" />
                        </div>
                        <div class="AddProductToOrder">
                            <form id="AddedProductForm" asp-controller="Product" asp-action="AddVariableToOrder" asp-area="Admin" data-ajax="true" 
                            data-ajax-method="Post" data-ajax-mode="replace" data-ajax-update="#orderProductTable" data-ajax-success="ResetForm()">
                                <input type="hidden" name="OrderId" value="@Model.Id" />
                                <div class="customerDetail" style="width:200px; float:right; margin-left:10px">
                                    <select id="ProductSelect" class="select2_Product form-control" name="ProductSelected" style="height:50px">
                                        @{
                                            var allProducts = _productService.GetAllPublishedProduct();
                                            foreach (var pr in allProducts)
                                            {
                                                <option value="@pr.Id">@pr.Title</option>
                                            }
                                        }

                                    </select>
                                </div>

                                <div class="customerDetail" style="width:200px;float:right;margin-left:10px" id="VariableSelector">
                                    <partial name="_variableSelector" model="@allProducts[0].Id" />
                                </div>
                                <div class="customerDetail" style="width:150px;float:right;margin-left:10px;">
                                    <input id="numberInput" class="form-control" name="Number" type="number" style="height:28px; text-align:center; padding:4px;" />
                                </div>
                                <div class="customerDetail" style="width:150px;float:right;margin-left:10px; ">
                                    <input id="priceInput" class="form-control" name="Price" type="number" style="height:28px; text-align:center; padding:4px;" />
                                </div>
                                <div class="customerDetail" style="width:100px;float:right;margin-left:10px;">
                                    <button class="ActionButton" style="width:120px;height: 28px;padding: 0px;" type="submit">افزودن کالا</button>
                                </div>

                                <div class="clear"></div>
                            </form>

                        </div>
                    </div>

                </div>
            </div>

        </div>

        <div class="col-sm-3 no-padding">
            <div class="col-sm-12">
                <div class="ibox float-e-margins">
                    <div class="ibox-title">
                        <h5>تراکنش مالی</h5>
                        <div class="ibox-tools">
                            <a class="collapse-link">
                                <i class="fa fa-chevron-up"></i>
                            </a>
                            <a class="close-link">
                                <i class="fa fa-times"></i>
                            </a>
                        </div>
                    </div>
                    <div class="ibox-content" style="padding:10px 5px;">
                        <div class="elementDetails" style="width:100%;">
                            <label style="text-align:right" class="col-sm-5 control-label">کد پیگیری</label>
                            <span style="text-align:right" class="col-sm-7 control-label">@Model.PaymentCode</span>
                        </div>
                        <div class="elementDetails" style="width:100%;">
                            <label style="text-align:right" class="col-sm-5 control-label">زمان واریز</label>
                            <span style="text-align:right" class="col-sm-7 control-label">@Model.PaymentDate?.ToString("dddd dd MMMM yyyy HH:mm", new CultureInfo("fa-IR"))</span>
                        </div>
                        <div class="clear"></div>
                    </div>
                </div>
            </div>

        </div>
        <div class="col-sm-3 no-padding">
            <div class="col-sm-12">
                <div class="ibox float-e-margins">
                    <div class="ibox-title">
                        <h5>عملیات</h5>
                        <div class="ibox-tools">
                            <a class="collapse-link">
                                <i class="fa fa-chevron-up"></i>
                            </a>
                            <a class="close-link">
                                <i class="fa fa-times"></i>
                            </a>
                        </div>
                    </div>
                    <div class="ibox-content" style="padding:10px 5px;">
                        <form id="form" method="post" action="/Admin/Product/OrderDetails/@Model.Id">
                            <div class="elementDetails" style="width:100%;">
                                <label style="text-align:right" class="col-sm-4 control-label">وضعیت</label>
                                <div class="col-sm-8">
                                    <select id="StatusSelect" name="StatusSelected" class="select2_Status form-control" style="width: 100%; height:40px;float:right;">
                                        @{

                                            if (Model.Status == "NoShipping")
                                            {
                                                <option selected value="NoShipping">در حال انجام</option>
                                            }
                                            else
                                            {
                                                <option value="NoShipping">در حال انجام</option>
                                            }
                                            if (Model.Status == "Completed")
                                            {
                                                <option selected value="Completed">کامل شده</option>
                                            }
                                            else
                                            {
                                                <option value="Completed">کامل شده</option>
                                            }
                                            if (Model.Status == "Canceled")
                                            {
                                                <option selected value="Canceled">لغو شده</option>
                                            }
                                            else
                                            {
                                                <option value="Canceled">لغو شده</option>
                                            }
                                            if (Model.Status == "Refund")
                                            {
                                                <option selected value="Refund">مرجوعی</option>
                                            }
                                            else
                                            {
                                                <option value="Refund">مرجوعی</option>
                                            }
                                        }

                                    </select>
                                </div>
                            </div>
                            <div class="elementDetails" style="width:100%;">
                                <label style="text-align:right" class="col-sm-4 control-label">کد رهگیری ارسال</label>
                                <div class="col-sm-8">
                                    <input class="form-control" name="TrackingCode" value="@Model.TrackingCode" />
                                </div>
                            </div>
                            <button class="ActionButton" type="submit">ذخیره</button>
                        </form>
                    </div>
                </div>
            </div>

        </div>
    </div>


</div>
@section Styles {
    <link href="~/plugin/select2/select2.min.css" rel="stylesheet" />
    @* <link href="~/plugin/leaflet/leaflet.css" rel="stylesheet" /> *@
}
@section Scripts {

    <script src="~/plugin/select2/select2.full.min.js"></script>
    @* <script src="~/plugin/leaflet/leaflet.js"></script> *@
    <script src="~/admin/plugin/sweetalert/sweetalert2.all.min.js"></script>

    <script>

        $(".select2_Status").select2({
            dir: "rtl",
            minimumResultsForSearch: -1,
        });

        $(".select2_Product").select2({
            dir: "rtl",
        });

        $(".select2_Variable").select2({
            dir: "rtl",
            minimumResultsForSearch: -1,
        });

        $('#ProductSelect').on('select2:select', function (e) {
            var data = e.params.data;

            $.ajax(
                {
                    type: "POST",
                    url: "/Admin/Product/LoadVariables",
                    data: { 'prId': data.id },
                    success:

                        function (result) {
                            $("#VariableSelector").html(result);
                            $(".select2_Variable").select2({
                                dir: "rtl",
                                minimumResultsForSearch: -1
                            });
                        },
                    error: function (req, status, error) {
                        window.alert("Error!");
                    }
                });
        });



    </script>

    <script>
        function DeleteProductOrder(id, orderId) {
            $.ajax({
                url: '/Admin/Product/DeleteProductOrder',
                type: "POST",
                data: { id: id, orderId: orderId },
                success: function (result) {
                    Swal.fire("حذف شد!", "آیتم با موفقیت حذف شد", "success");
                    $("#orderProductTable").html(result);
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    Swal.fire("خطا", "عملیات با خطا مواجه شد!", "error");
                }
            });
        }
    </script>

    <script>
        function ResetForm(){
            $("#numberInput").val('');
            $("#priceInput").val('');
        }
    </script>
    <script>
        function DeleteCouponOrder(orderId) {
            $.ajax({
                url: '/Admin/Product/DeleteCouponOrder',
                type: "POST",
                data: { orderId: orderId },
                success: function (result) {
                    Swal.fire("حذف شد!", "کوپن تخفیف با موفقیت حذف شد", "success");
                    $("#orderProductTable").html(result);
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    Swal.fire("خطا", "عملیات با خطا مواجه شد!", "error");
                }
            });
        }
    </script>

    

}

