@using Core.Services.Interfaces;
@using Core.ViewModel;
@using Datalayer.Entities
@using System.Web;

@model Page

@{
    ViewBag.Title = "ویرایش برگه";

}

<div class="wrapper wrapper-content animated fadeInRight">
    @using (Html.BeginForm("Edit", "Page", FormMethod.Post, new { @class = "form-horizontal MainForm" }))
    {
        <input type="hidden" name="PageId" value="@Model.Id" />
        <div class="row">
            <div class="col-sm-9 no-padding">
                <div class="col-sm-12">
                    @Html.ValidationSummary(true, "لطفا خطاهای زیر را برطرف نمایید:", new { @class = "text-danger alert alert-danger" })
                </div>
                <div class="col-sm-12">
                    @{
                        if (ViewBag.Message != null)
                        {
                            <div class="col-sm-12 alert alert-success">
                                <span>@ViewBag.Message</span>
                            </div>
                        }
                    }
                </div>
                <div class="col-sm-12">
                    <div class="ibox float-e-margins">
                        <div class="ibox-title">
                            <h5>محتوای اصلی</h5>
                            <div class="ibox-tools">
                                <a class="collapse-link">
                                    <i class="fa fa-chevron-up"></i>
                                </a>
                                <a class="close-link">
                                    <i class="fa fa-times"></i>
                                </a>
                            </div>
                        </div>

                        <div class="ibox-content">

                            <div class="form-group">
                                <label style="text-align:right" class="col-sm-2 control-label">تیتر</label>

                                <div class="col-sm-10">
                                    @Html.EditorFor(model => model.Title, new { htmlAttributes = new { @class = "form-control" } })
                                    @Html.ValidationMessageFor(model => model.Title, "", new { @class = "text-danger" })
                                </div>
                            </div>

                            <div class="form-group">
                                <label style="text-align:right" class="col-sm-2 control-label">پیوند یکتا</label>

                                <div class="col-sm-10">
                                    <span>@HttpUtility.UrlDecode(Model.Slug)</span>
                                </div>
                            </div>

                            <div class="hr-line-dashed"></div>
                            <div class="form-group">
                                <label style="text-align:right; padding:18px;" class="col-sm-10 control-label">توضیحات اصلی</label>
                                <button data-target="#Gallery" id="btn_Gallery" data-toggle="modal" style="width:138px;" class="btn btn-primary col-sm-2" type="button"><i class="fa fa-picture-o"></i>&nbsp;&nbsp;<span class="bold">گالری</span></button>
                                <div class="col-sm-12">
                                    @Html.TextAreaFor(model => model.Content, new { @class = "form-control", id = "mainText" })
                                    @Html.ValidationMessageFor(model => model.Content, "", new { @class = "text-danger" })
                                </div>
                                @*<div id="AutoSaveResult">
                            @Html.Partial("_AutoSaveResult", -1)
                            </div>*@
                            </div>

                        </div>
                    </div>
                </div>


            </div>
            <div class="col-sm-3 no-padding">


                <div class="col-sm-12">
                    <div class="ibox float-e-margins">
                        <div class="ibox-title">
                            <h5>عملیات</h5>
                            <div class="ibox-tools">
                                <a class="collapse-link">
                                    <i class="fa fa-chevron-up"></i>
                                </a>
                                <a class="close-link">
                                    <i class="fa fa-times"></i>
                                </a>
                            </div>
                        </div>
                        <div class="ibox-content" style="padding:15px 10px 20px 10px;">

                            <button class="btn btn-primary" style="width:145px;display: block;margin: 0px auto 5px;" type="submit"><i class="fa fa-check"></i>ذخیره</button>
                        </div>
                    </div>
                </div>

            </div>

        </div>
    }


    <partial name="_GalleryModal" />
</div>

@section Scripts {
    <script src="~/admin/plugin/summernote/summernote.min.js"></script>
    <script src="~/admin/plugin/summernote/summernote-image-title.js"></script>
    <script src="~/admin/plugin/summernote/summernote-fa-ir.min.js"></script>

    <script>
        $(document).ready(function () {
            $('#mainText').summernote({
                lang: 'fa-ir',
                height: 500,
                imageTitle: {
                    specificAltField: true,
                },
                popover: {
                    image: [
                        ['image', ['resizeFull', 'resizeHalf', 'resizeQuarter', 'resizeNone']],
                        ['float', ['floatLeft', 'floatRight', 'floatNone']],
                        ['remove', ['removeMedia']],
                        ['custom', ['imageTitle']],
                    ],
                },
                callbacks: {
                    onImageUpload: function (files) {
                        for (let i = 0; i < files.length; i++) {
                            UploadImage(files[i]);
                        }
                    }
                },
            });


        });


    </script>

    <script>
        function UploadImage(file) {
            var url = "@Url.Action("UploadFile", "Home")";

            formData = new FormData();
            formData.append("aUploadedFile", file);
            $.ajax({
                type: "POST",
                url: url,
                data: formData,
                cache: false,
                contentType: false,
                processData: false,
                success: function (FileUrl) {
                    // alert(FileUrl);
                    var imgNode = document.createElement("img");
                    imgNode.src = FileUrl;
                    $("#Content").summernote("insertNode", imgNode);
                },
                error: function (data) {
                    alert(data.responseText);
                }
            });
        }
    </script>

    <script>
        function DeleteImageCompleted(data, id) {
            if (data == "True") {
                $("#image_" + id).fadeOut('slow');

                RefreshImages();

            } else {
                Swal.fire("پاک نشد!", "این عکس، تصویر شاخص یک مطلب است و شما نمی توانید آن را پاک کنید", "error");
            }
        }
    </script>
}

